name: Publish Packages

on:
  push:
    tags:
      - 'v*'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Publish Core Package
        run: |
          cd packages/core
          
          # Prepare minimal package for publication
          mkdir -p dist
          
          # Copy source files as basic dist
          cp src/index.ts dist/index.js
          cp src/types.ts dist/types.js  
          cp src/client.ts dist/client.js
          cp src/constants.ts dist/constants.js
          cp src/utils.ts dist/utils.js
          
          # Create basic type definitions
          echo "export * from './types';" > dist/index.d.ts
          echo "export * from './client';" >> dist/index.d.ts
          echo "export * from './constants';" >> dist/index.d.ts
          echo "export * from './utils';" >> dist/index.d.ts
          
          # Publish
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish React Package  
        run: |
          cd packages/react
          mkdir -p dist
          cp -r src/* dist/ 2>/dev/null || echo "Copied source files"
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish Vue Package
        run: |
          cd packages/vue  
          mkdir -p dist
          cp -r src/* dist/ 2>/dev/null || echo "Copied source files"
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish Nuxt Package
        run: |
          cd packages/nuxt
          mkdir -p dist  
          cp -r src/* dist/ 2>/dev/null || echo "Copied source files"
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish Next Package
        run: |
          cd packages/next
          mkdir -p dist
          cp -r src/* dist/ 2>/dev/null || echo "Copied source files"
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          body: |
            ## 🚀 PayGate JS SDK ${{ github.ref_name }}

            ### 📦 Packages Published
            - `@filanodev/paygate-core@${{ github.ref_name }}`
            - `@filanodev/paygate-react@${{ github.ref_name }}`
            - `@filanodev/paygate-vue@${{ github.ref_name }}`
            - `@filanodev/paygate-nuxt@${{ github.ref_name }}`
            - `@filanodev/paygate-next@${{ github.ref_name }}`

            ### 🔧 Installation
            ```bash
            npm install @filanodev/paygate-core
            ```

            ### 📚 Documentation
            - [README](https://github.com/filanodev/paygate-js-sdk#readme)
            - [Quick Start Guide](https://github.com/filanodev/paygate-js-sdk/blob/main/docs/guide/quick-start.md)

            ---
            Développé avec ❤️ par [Filano](https://me.fedapay.com/filano_don) pour la communauté JavaScript africaine
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}